{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}
{% load static %}

{% block css %}
<style>
    .form-section {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        padding: 1.5rem;
    }
    .form-section-header {
        border-bottom: 2px solid #f0f0f0;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
    }
    .form-section-header h3 {
        color: #2c3e50;
        font-size: 1.5rem;
        margin: 0;
    }
    .form-label {
        font-weight: 500;
        color: #2c3e50;
    }
    .form-control:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    .btn-primary {
        background-color: #3498db;
        border-color: #3498db;
        padding: 0.75rem 2rem;
        font-weight: 500;
    }
    .btn-primary:hover {
        background-color: #2980b9;
        border-color: #2980b9;
    }
    .form-check-input:checked {
        background-color: #3498db;
        border-color: #3498db;
    }
    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #f0f0f0;
        font-weight: 500;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .help-text {
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock css %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-section">
                <div class="form-section-header">
                    <h3><i class="fas fa-trophy me-2"></i>Создание нового турнира</h3>
                </div>
                
                <form method="post" enctype="multipart/form-data" id="tournamentForm">
                    {% csrf_token %}
                    
                    <!-- Основные поля формы турнира -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="fas fa-info-circle me-2"></i>Основная информация</h3>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-12">
                                {{ form.title|as_crispy_field }}
                            </div>
                            <div class="col-md-12">
                                {{ form.image|as_crispy_field }}
                            </div>
                            <div class="col-md-12">
                                {{ form.location|as_crispy_field }}
                            </div>
                            <div class="col-md-12">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Стили борьбы -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="fas fa-fist-raised me-2"></i>Стили борьбы</h3>
                        </div>
                        <div class="mb-3">
                            {{ form.fighting_styles }}
                        </div>
                    </div>

                    <!-- Даты и цены регистрации -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="fas fa-calendar-alt me-2"></i>Даты и цены регистрации</h3>
                        </div>
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="form-group mb-4">
                            <label class="form-label">Выберите тип регистрации:</label>
                            <select id="info-type" class="form-select">
                                <option disabled selected value hidden>-- Выберите вид регистрации --</option>
                                <option value="level">Ранняя-обычная-поздняя</option>
                                <option value="normal">Обычная</option>
                            </select>
                        </div>
                        
                        <div id="dynamic-fields" class="row g-3">
                            <!-- Сюда будут добавляться поля -->
                        </div>
                    </div>

                    <!-- Даты турнира -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="fas fa-clock me-2"></i>Даты турнира</h3>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.registration_deadline|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.tournament_start|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.tournament_end|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- Дополнительные настройки -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3><i class="fas fa-cog me-2"></i>Дополнительные настройки</h3>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">Статус турнира</label>
                                    {{ form.status }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="form-check">
                                        {{ form.newbies }}
                                        <label class="form-check-label" for="{{ form.newbies.id_for_label }}">
                                            Разрешить участие новичкам
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Блок с категориями -->
                    <div id="categoriesSection" class="form-section" style="display: none;">
                        <div class="form-section-header">
                            <h3><i class="fas fa-list me-2"></i>Выберите категории</h3>
                        </div>
                        <div id="categoriesList">
                            <!-- Сюда будет загружаться список категорий -->
                        </div>
                    </div>
                    
                    <!-- Блок с весовыми категориями -->
                    <div id="weightsSection" class="form-section" style="display: none;">
                        <div class="form-section-header">
                            <h3><i class="fas fa-weight me-2"></i>Настройка весовых категорий</h3>
                        </div>
                        <div id="weightsForm">
                            <!-- Сюда будет загружаться форма весов -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>Создать турнир
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fightingStylesSelect = document.getElementById('id_fighting_styles');
    const categoriesSection = document.getElementById('categoriesSection');
    const weightsSection = document.getElementById('weightsSection');
    
    // Изначально скрываем обе секции
    if (categoriesSection) categoriesSection.style.display = 'none';
    if (weightsSection) weightsSection.style.display = 'none';
    
    if (fightingStylesSelect) {
        fightingStylesSelect.addEventListener('change', function() {
            const selectedOptions = this.querySelectorAll('input[type="checkbox"]:checked');
            const styleIds = Array.from(selectedOptions).map(opt => opt.value);
            
            if (styleIds.length > 0) {
                // Скрываем секцию весов при изменении стилей
                if (weightsSection) weightsSection.style.display = 'none';
                
                fetch('/get-categories/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `styles=${styleIds.join(',')}`
                })
                .then(response => response.json())
                .then(data => {
                    if (categoriesSection) {
                        categoriesSection.style.display = 'block';
                        document.getElementById('categoriesList').innerHTML = data.categories_html;
                        
                        // Добавляем обработчик изменения для категорий
                        const categoryCheckboxes = document.querySelectorAll('#categoriesList input[type="checkbox"]');
                        categoryCheckboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', updateWeightsSection);
                        });
                    }
                });
            } else {
                // Если не выбрано ни одного стиля, скрываем обе секции
                if (categoriesSection) categoriesSection.style.display = 'none';
                if (weightsSection) weightsSection.style.display = 'none';
            }
        });
    }
    
    // Функция для обновления секции весов
    function updateWeightsSection() {
        const selectedCategories = document.querySelectorAll('#categoriesList input[type="checkbox"]:checked');
        
        if (selectedCategories.length > 0) {
            const categoryIds = Array.from(selectedCategories).map(c => c.value);
            
            fetch('/get-weights-form/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `categories=${categoryIds.join(',')}`
            })
            .then(response => response.json())
            .then(data => {
                if (weightsSection) {
                    weightsSection.style.display = 'block';
                    document.getElementById('weightsForm').innerHTML = data.weights_html || '';
                }
            });
        } else {
            if (weightsSection) weightsSection.style.display = 'none';
        }
    }
});

// Обработчик для типа регистрации
document.getElementById('info-type').addEventListener('change', function() {
    const type = this.value;
    const container = document.getElementById('dynamic-fields');
    container.innerHTML = ''; // Очищаем предыдущие поля
    
    if (type === 'level') {
        container.innerHTML = `
            <div class="col-md-6">
                {{ form.early_registration_start|as_crispy_field }}
            </div>
            <div class="col-md-6">
                {{ form.early_registration_price|as_crispy_field }}
            </div>

            <div class="col-md-6">
                {{ form.regular_registration_start|as_crispy_field }}
            </div>
            <div class="col-md-6">
                {{ form.regular_registration_price|as_crispy_field }}
            </div>

            <div class="col-md-6">
                {{ form.late_registration_start|as_crispy_field }}
            </div>
            <div class="col-md-6">
                {{ form.late_registration_price|as_crispy_field }}
            </div>
        `;
    } 
    else if (type === 'normal') {
        container.innerHTML = `
            <div class="col-md-6">
                {{ form.regular_registration_start|as_crispy_field }}
            </div>
            <div class="col-md-6">
                {{ form.regular_registration_price|as_crispy_field }}
            </div>
        `;
    }
});
</script>

{% endblock content %}